name: ci-actions

on:
  push:
    branches:
      - main

jobs:
  depoly:
    runs-on: ubuntu-latest

    steps:
      - name: SSH into EC2 instance and deploy
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.HOST }}
          username: ${{ secrets.USER }}
          key: ${{ secrets.KEY }}
          envs: |
            AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
            AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
            AWS_REGION=ap-south-1
            REGISTRY: ${{ steps.login-ecr.outputs.registry }}
            REPOSITORY: node-app
            IMAGE_TAG: ${{ github.sha }}
          script: |
            aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 976566383149.dkr.ecr.ap-south-1.amazonaws.com/node-app
            docker build -t $REGISTRY/$REPOSITORY:$IMAGE_TAG .
            docker push $REGISTRY/$REPOSITORY:$IMAGE_TAG
            docker pull $REGISTRY/$REPOSITORY:$IMAGE_TAG

      
      
   
